#!/usr/bin/env bash

# Claude Code Pre-Tool-Use Hook: Bash Guards
# Purpose: Prevent problematic Bash commands:
#   1. CD Guard: Block cd commands (use subshells instead: (cd dir && command))
#   2. Find Guard: Block find without node_modules exclusion (causes delays)

# Read the hook input from stdin
input=$(cat)

# Save the input to a file for inspection (useful for debugging)
echo "$input" > ~/.claude.lasttool.json

# Extract tool name and tool input
tool_name=$(echo "$input" | jq -r '.tool_name // empty')
command=$(echo "$input" | jq -r '.tool_input.command // empty')

# Only apply this hook to Bash tool calls
if [[ "$tool_name" != "Bash" ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "allow",
            permissionDecisionReason: "Not a shell command"
        }
    }'
    exit 0
fi

# Normalize the command by removing leading/trailing whitespace
normalized_cmd=$(echo "$command" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# GUARD 1: Find Guard
# Block find commands that don't exclude node_modules (causes excessive delays)
if [[ "$normalized_cmd" =~ ^find[[:space:]] ]] && [[ ! "$normalized_cmd" =~ node_modules ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "deny",
            permissionDecisionReason: "To avoid excessive delays, do not use `find` without excluding `node_modules`"
        }
    }'
    exit 0
fi

# GUARD 2: CD Guard
# Block cd commands - they should be wrapped in a subshell
if [[ "$normalized_cmd" =~ ^cd([[:space:]]|$) ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "deny",
            permissionDecisionReason: "CD Guard: cd commands should be wrapped in a subshell: (cd subdir && command)"
        }
    }'
    exit 0
fi

# Allow all other commands
jq -n '{
    hookSpecificOutput: {
        hookEventName: "PreToolUse",
        permissionDecision: "allow",
        permissionDecisionReason: "Command allowed"
    }
}'
exit 0
