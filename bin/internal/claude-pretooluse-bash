#!/usr/bin/env bash

# Claude Code Pre-Tool-Use Hook: Bash Guards
# Purpose: Prevent problematic Bash commands:
#   1. Git Mutation Guard: Block git commands that mutate state (require human approval)
#   2. Find Guard: Block find without node_modules exclusion (causes delays)
#   3. CD Guard: Block cd commands (use subshells instead: (cd dir && command))

# Read the hook input from stdin
input=$(cat)

# Save the input to a file for inspection (useful for debugging)
echo "$input" > ~/.claude.lasttool.json

# Extract tool name and tool input
tool_name=$(echo "$input" | jq -r '.tool_name // empty')
command=$(echo "$input" | jq -r '.tool_input.command // empty')

# Only apply this hook to Bash tool calls
if [[ "$tool_name" != "Bash" ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "allow",
            permissionDecisionReason: "Not a shell command"
        }
    }'
    exit 0
fi

# Normalize the command by removing leading/trailing whitespace
normalized_cmd=$(echo "$command" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# GUARD 1: Git Mutation Guard
# Block git commands that mutate state unless prefixed with HUMAN_APPROVED_THIS_COMMAND=1
# Read-only git commands that are safe to run without approval:
GIT_READONLY_COMMANDS="status|diff|show|log|shortlog|reflog|blame|annotate|grep|ls-files|ls-tree|ls-remote|cat-file|rev-parse|rev-list|describe|name-rev|for-each-ref|var|fsck|verify-commit|verify-tag|check-ignore|check-attr|check-mailmap|diff-tree|diff-files|diff-index|range-diff|help|version|count-objects|cherry|whatchanged|merge-base|get-tar-commit-id"

if [[ "$normalized_cmd" =~ ^git[[:space:]] ]]; then
    # Extract the git subcommand (second word)
    git_subcommand=$(echo "$normalized_cmd" | awk '{print $2}')

    # Check if it's NOT a read-only command
    if [[ ! "$git_subcommand" =~ ^($GIT_READONLY_COMMANDS)$ ]]; then
        jq -n '{
            hookSpecificOutput: {
                hookEventName: "PreToolUse",
                permissionDecision: "deny",
                permissionDecisionReason: "Git Mutation Guard: git commands that mutate state require human approval. Prefix the command with the HUMAN_APPROVED_THIS_COMMAND=1 environment variable. Example: `HUMAN_APPROVED_THIS_COMMAND=1 git commit ...`\n\nIMPORTANT: You MUST seek explicit approval from a human before adding this environment variable, unless you are certain beyond any shadow of a doubt that the human has approved this instance of this particular operation. Be aware that prior approval of an operation does not imply future repeated consent unless explicitly declared. When in doubt, ask the human."
            }
        }'
        exit 0
    fi
fi

# GUARD 2: Find Guard
# Block find commands that don't exclude node_modules (causes excessive delays)
if [[ "$normalized_cmd" =~ ^find[[:space:]] ]] && [[ ! "$normalized_cmd" =~ node_modules ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "deny",
            permissionDecisionReason: "To avoid excessive delays, do not use `find` without excluding `node_modules`"
        }
    }'
    exit 0
fi

# GUARD 3: CD Guard
# Block cd commands - they should be wrapped in a subshell
if [[ "$normalized_cmd" =~ ^cd([[:space:]]|$) ]]; then
    jq -n '{
        hookSpecificOutput: {
            hookEventName: "PreToolUse",
            permissionDecision: "deny",
            permissionDecisionReason: "CD Guard: cd commands should be wrapped in a subshell: (cd subdir && command)"
        }
    }'
    exit 0
fi

# Allow all other commands
jq -n '{
    hookSpecificOutput: {
        hookEventName: "PreToolUse",
        permissionDecision: "allow",
        permissionDecisionReason: "Command allowed"
    }
}'
exit 0
